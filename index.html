<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climax Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #0f111a;
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        .card {
            background: #1c1f2e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            position: relative;
            transition: border 0.3s;
            border: 2px solid transparent;
        }

        h1 {
            margin: 0;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .clock {
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            color: #00d2ff;
            margin-top: 5px;
            font-weight: bold;
        }

        .sub-info {
            font-size: 0.85em;
            color: #8b9bb4;
            margin-top: 5px;
        }

        /* GRID PRINCIPAL */
        .grid-vals {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        .big-val {
            font-size: 3rem;
            font-weight: bold;
        }

        .lbl {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #666;
        }

        .c-temp {
            color: #ff4757;
        }

        .c-hum {
            color: #2ed573;
        }

        /* M√ÅXIMAS E M√çNIMAS */
        .min-max-box {
            display: flex;
            justify-content: space-around;
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }

        .mm-val {
            font-weight: bold;
            color: #fff;
        }

        /* IA CARD */
        .ai-card {
            border-left: 4px solid #00ff88;
            background: #252a38;
            text-align: left;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            color: #dcdde1;
            white-space: pre-line;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .ai-title {
            font-weight: bold;
            color: #8b9bb4;
            font-size: 0.8em;
            margin-bottom: 5px;
            display: block;
        }

        /* SLIDER DE ALERTA */
        .slider-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            accent-color: #ff4757;
        }

        .limit-val {
            font-weight: bold;
            color: #ff4757;
            font-size: 1.2em;
            min-width: 50px;
        }

        /* BOT√ÉO POWER */
        .btn-main {
            background: #3742fa;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 15px;
        }

        .btn-main.active {
            background: #ff4757;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.5);
        }

        /* GR√ÅFICO E BOT√ïES */
        .chart-box {
            height: 350px;
            position: relative;
            width: 100%;
        }

        .top-btn-group {
            position: absolute;
            top: 15px;
            right: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85em;
            transition: 0.2s;
            white-space: nowrap;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* RESPONSIVIDADE (CELULAR) */
        @media (max-width: 600px) {
            .big-val {
                font-size: 2.2rem;
            }

            .container {
                padding: 5px;
            }

            /* Bot√µes do gr√°fico saem de cima e v√£o para uma barra pr√≥pria */
            .top-btn-group {
                position: static;
                display: flex;
                justify-content: center;
                margin-bottom: 10px;
                width: 100%;
            }

            .icon-btn {
                flex: 1;
                text-align: center;
            }

            /* Bot√µes ocupam largura total */
            .chart-box {
                height: 300px;
            }
        }

        /* FULLSCREEN MODE */
        .fullscreen-mode {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            background: #0f111a;
            z-index: 99999;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .fullscreen-mode .chart-box {
            flex: 1;
            height: auto;
        }

        .fullscreen-mode .top-btn-group {
            position: static;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .fs-close {
            display: none;
            background: #ff4757;
            border: none;
            font-weight: bold;
        }

        .fullscreen-mode .fs-close {
            display: block;
        }

        /* Classe de Alerta Visual (Piscar Borda) */
        .alert-mode {
            border: 2px solid #ff4757;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 71, 87, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 71, 87, 0);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="card" id="main-card">
            <h1>Projeto Climax</h1>
            <div class="clock" id="digital-clock">--:--:--</div>
            <div class="sub-info">
                <span id="sys-status">üî¥ Conectando...</span> | WiFi: <span id="rssi">--</span>dBm
            </div>

            <div class="grid-vals">
                <div>
                    <div class="big-val c-temp" id="val-temp">--</div>
                    <div class="lbl">Temperatura ¬∞C</div>
                    <div class="min-max-box">
                        <span>Min: <span id="min-t" class="mm-val">--</span></span>
                        <span>Max: <span id="max-t" class="mm-val">--</span></span>
                    </div>
                </div>
                <div>
                    <div class="big-val c-hum" id="val-hum">--</div>
                    <div class="lbl">Umidade %</div>
                    <div class="min-max-box">
                        <span>Min: <span id="min-h" class="mm-val">--</span></span>
                        <span>Max: <span id="max-h" class="mm-val">--</span></span>
                    </div>
                </div>
            </div>

            <div style="text-align: left; margin-top: 15px;">
                <label class="lbl" style="font-size: 0.7em;">Definir Alerta de Temperatura (¬∞C)</label>
                <div class="slider-container">
                    <input type="range" id="alert-slider" min="20" max="40" step="0.5" value="30"
                        oninput="updateLimit(this.value)">
                    <span id="limit-disp" class="limit-val">30.0</span>
                </div>
            </div>

            <button id="btn-pwr" class="btn-main" onclick="togglePower()">LIGAR SISTEMA</button>
        </div>

        <div class="card ai-card">
            <span class="ai-title">Analise IA:</span>
            <div id="ai-msg">Aguardando dados...</div>
        </div>

        <div class="card" id="card-graph">
            <div class="top-btn-group">
                <button class="icon-btn" onclick="exportToCSV()">üì• Baixar CSV</button>
                <button class="icon-btn" onclick="openFullscreen()">‚õ∂ Tela Cheia</button>
                <button class="icon-btn fs-close" onclick="closeFullscreen()">X SAIR</button>
            </div>

            <div class="chart-box">
                <canvas id="myChart"></canvas>
            </div>
            <div style="font-size:0.75rem; color:#555; margin-top:5px;">
                CTRL+Scroll: Zoom | Arraste: Mover Hist√≥rico
            </div>
        </div>
    </div>

    <script>
        const broker = 'wss://test.mosquitto.org:8081';
        const client = mqtt.connect(broker);

        let lastHeartbeat = Date.now();
        let isPowerOn = false;

        // Vari√°veis de Recordes e Limite
        let maxT = -100, minT = 100;
        let maxH = -100, minH = 100;
        let tempLimite = 30.0; // Valor padr√£o do slider
        let currentTemp = 0;   // Guarda temperatura atual para verificar alerta

        // Rel√≥gio
        setInterval(() => {
            const now = new Date();
            document.getElementById('digital-clock').innerText = now.toLocaleTimeString();
        }, 1000);

        // --- L√ìGICA DO SLIDER ---
        function updateLimit(val) {
            tempLimite = parseFloat(val);
            document.getElementById('limit-disp').innerText = tempLimite.toFixed(1);
            checkVisualAlert(); // Verifica imediatamente ao mover
        }

        // Verifica se deve ficar vermelho (Baseado no Slider OU na msg da IA)
        function checkVisualAlert(aiAlert = false) {
            const mainCard = document.getElementById('main-card');
            const aiCard = document.querySelector('.ai-card');

            // Fica vermelho se: Temp atual > Limite do Slider OU IA mandou ALERTA
            if (currentTemp > tempLimite || aiAlert) {
                mainCard.classList.add('alert-mode');
                aiCard.style.borderLeftColor = "#ff4757";
                if (navigator.vibrate) navigator.vibrate(200); // Vibra
            } else {
                mainCard.classList.remove('alert-mode');
                aiCard.style.borderLeftColor = "#00ff88";
            }
        }

        // --- GR√ÅFICO ---
        const ctx = document.getElementById('myChart').getContext('2d');
        const radiusLogic = (ctx) => {
            const index = ctx.dataIndex;
            const count = ctx.dataset.data.length;
            return index === count - 1 ? 6 : 0;
        };

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Temp', borderColor: '#ff4757', backgroundColor: 'rgba(255, 71, 87, 0.1)', data: [], fill: true, tension: 0.3, pointRadius: radiusLogic, pointHoverRadius: 8, pointHitRadius: 20 },
                    { label: 'Umid', borderColor: '#2ed573', backgroundColor: 'rgba(46, 213, 115, 0.1)', data: [], fill: true, tension: 0.3, pointRadius: radiusLogic, pointHoverRadius: 8, pointHitRadius: 20 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                interaction: { mode: 'index', intersect: false },
                scales: { x: { ticks: { maxTicksLimit: 6, color: '#666' }, grid: { display: false } }, y: { grid: { color: '#333' } } },
                plugins: { zoom: { zoom: { wheel: { enabled: true, modifierKey: 'ctrl' }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } } }
            }
        });

        // --- MQTT ---
        client.on('connect', () => {
            document.getElementById('sys-status').innerText = "üü¢ Sistema Online";
            document.getElementById('sys-status').style.color = "#00e676";
            client.subscribe('climax/esp32/#');
            client.subscribe('climax/ia/mensagem');
            client.subscribe('climax/web/resposta');
            client.subscribe('climax/web/pontografico');
            client.subscribe('climax/node/status');
            client.publish('climax/web/requisicao', 'get');
        });

        client.on('message', (topic, message) => {
            const msg = message.toString();

            // TEMPERATURA
            if (topic.includes('temperatura')) {
                let val = parseFloat(msg);
                currentTemp = val;
                document.getElementById('val-temp').innerText = val.toFixed(1);

                // L√≥gica de Recordes
                if (val > maxT) { maxT = val; document.getElementById('max-t').innerText = val.toFixed(1); }
                if (val < minT) { minT = val; document.getElementById('min-t').innerText = val.toFixed(1); }

                checkVisualAlert(); // Verifica alerta a cada nova leitura
            }

            // UMIDADE
            if (topic.includes('umidade')) {
                let val = parseFloat(msg);
                document.getElementById('val-hum').innerText = val.toFixed(0);
                if (val > maxH) { maxH = val; document.getElementById('max-h').innerText = val.toFixed(0); }
                if (val < minH) { minH = val; document.getElementById('min-h').innerText = val.toFixed(0); }
            }

            if (topic.includes('rssi')) document.getElementById('rssi').innerText = msg;
            if (topic.includes('pontografico')) { addPointToChart(JSON.parse(msg)); }
            if (topic.includes('node/status')) lastHeartbeat = Date.now();

            if (topic.includes('ia/mensagem')) {
                let clean = msg.replace("üü¢ ONLINE | ", "").replace("üî¥ SISTEMA OFFLINE", "ERRO CR√çTICO");
                document.getElementById('ai-msg').innerText = clean;
                // Passa True se a IA detectar alerta critico
                checkVisualAlert(msg.includes("ALERTA") || msg.includes("OFFLINE"));
            }

            if (topic.includes('web/resposta')) { loadHistoryChart(JSON.parse(msg)); }
        });

        function formatTime(timestamp) { return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }

        function loadHistoryChart(dados) {
            chart.data.labels = []; chart.data.datasets[0].data = []; chart.data.datasets[1].data = [];

            // Inicializa recordes com base no hist√≥rico recebido
            if (dados.length > 0) {
                // Reseta para pegar do hist√≥rico
                maxT = -100; minT = 100; maxH = -100; minH = 100;
            }

            dados.forEach(d => {
                chart.data.labels.push(formatTime(d.time));
                chart.data.datasets[0].data.push(d.temp);
                chart.data.datasets[1].data.push(d.hum);

                // Atualiza recordes com dados do hist√≥rico tamb√©m
                if (d.temp > maxT) maxT = d.temp; if (d.temp < minT) minT = d.temp;
                if (d.hum > maxH) maxH = d.hum; if (d.hum < minH) minH = d.hum;
            });

            // Atualiza tela com recordes
            if (maxT !== -100) {
                document.getElementById('max-t').innerText = maxT.toFixed(1);
                document.getElementById('min-t').innerText = minT.toFixed(1);
                document.getElementById('max-h').innerText = maxH.toFixed(0);
                document.getElementById('min-h').innerText = minH.toFixed(0);
            }

            chart.update();
            if (chart.data.labels.length > 10) chart.pan({ x: -Number.MAX_SAFE_INTEGER }, undefined, 'default');
        }

        function addPointToChart(d) {
            chart.data.labels.push(formatTime(d.time));
            chart.data.datasets[0].data.push(d.t);
            chart.data.datasets[1].data.push(d.h);
            if (chart.data.labels.length > 2000) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); chart.data.datasets[1].data.shift(); }
            chart.update();
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFFHora;Temperatura;Umidade\n";
            const total = chart.data.labels.length;
            for (let i = total - 1; i >= 0; i--) {
                let label = chart.data.labels[i];
                let t = chart.data.datasets[0].data[i].toString().replace('.', ',');
                let h = chart.data.datasets[1].data[i].toString().replace('.', ',');
                csvContent += `${label};${t};${h}\n`;
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const now = new Date();
            link.setAttribute("download", `climax_${now.getHours()}h${now.getMinutes()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        setInterval(() => {
            if (Date.now() - lastHeartbeat > 10000) {
                document.getElementById('sys-status').innerText = "‚ö†Ô∏è Servidor OFF";
                document.getElementById('sys-status').style.color = "orange";
            }
        }, 5000);

        function togglePower() {
            isPowerOn = !isPowerOn;
            const btn = document.getElementById('btn-pwr');
            client.publish('climax/comando', isPowerOn ? 'LIGAR' : 'DESLIGAR');
            btn.innerText = isPowerOn ? "DESLIGAR VENTILA√á√ÉO" : "LIGAR SISTEMA";
            if (isPowerOn) btn.classList.add('active'); else btn.classList.remove('active');
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function openFullscreen() {
            document.getElementById('card-graph').classList.add('fullscreen-mode');
            chart.resize();
        }
        function closeFullscreen() {
            document.getElementById('card-graph').classList.remove('fullscreen-mode');
            chart.resize();
        }
    </script>
</body>

</html>